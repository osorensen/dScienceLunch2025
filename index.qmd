---
title: "Dynamic Structural Equation Models with Regression Splines"
author: "Øystein Sørensen"
format: revealjs
editor: source
bibliography: references.bib
---

```{r, message=FALSE}
library(tidyverse)
theme_set(theme_bw())
theme_update(panel.grid = element_blank())
```


# Intensive Longitudinal Data

## Classical Growth Model


```{r, fig.width=6, fig.height=4, fig.align='center'}
set.seed(2)
growth_dat <- tibble(
  id = seq_len(20),
  baseline_age = runif(20, min = 6, max = 8),
  b = rnorm(20),
  group = factor(c(rep(1, 10), rep(2, 10)))
) %>% 
  uncount(5) %>% 
  mutate(
    time = c(0, runif(nrow(.) - 1, min = 1, max = 3))
  ) %>% 
  group_by(id) %>% 
  mutate(time = cumsum(time)) %>% 
  ungroup() %>% 
  mutate(age = baseline_age + time) %>% 
  select(id, age, b, group) %>% 
  mutate(
    slope = if_else(group == 1, 1, .5),
    slope2 = if_else(group == 1, .1, .05),
    y = slope * age - slope2 * (age - 12)**2 + b + rnorm(nrow(.), sd = 2)
  )
```

```{r, fig.width=6, fig.height=4, fig.align='center'}
p <- ggplot(filter(growth_dat, group == 1), aes(x = age, y = y)) +
  geom_point() + 
  geom_line(aes(group = id), alpha = .4) + 
  xlab("Age") + 
  ylab("Trait")

p
```


## Classical Growth Model

```{r, fig.width=6, fig.height=4, fig.align='center'}
p + 
  geom_smooth(method = "gam")
```

## Classical Growth Model

```{r, fig.width=6, fig.height=4, fig.align='center'}
p <- ggplot(growth_dat, aes(x = age, y = y, group = group, color = group)) +
  geom_point() + 
  geom_line(aes(group = id), alpha = .4) + 
  xlab("Age") + 
  ylab("Trait") + 
  ggthemes::scale_color_colorblind() + 
  labs(color = "Group")

p
```

# Traits

---

![](https://www.proeves.com/blog/wp-content/uploads/2020/12/cognitive-development-theory.jpg){fig-align="center"}

---

![](https://www.frontiersin.org/files/Articles/497245/fnhum-14-497245-HTML/image_m/fnhum-14-497245-g001.jpg){fig-align="center"}




# Ecological Momentary Assessment

---

![](images/burke_paper.jpeg){fig-align="center"}

@burkeEcologicalMomentaryAssessment2017


---

![](images/judd_paper.jpg){fig-align="center"}

@juddInterindividualDifferencesCognitive2024

## Ecological Momentary Assessment

Individual differences in dynamics:

:::{.incremental}
- Autocorrelation.
- Cross-correlation.
- Noise/predictability.
:::

---

![](https://psycnet.apa.org/ftasset/journals/met/25/5/images/met_25_5_610_fig6a.gif){fig-align="center"}

@mcneishPrimerTwolevelDynamic2020

---

![](https://psycnet.apa.org/ftasset/journals/met/25/5/images/met_25_5_610_fig8a.gif){fig-align="center"}

@mcneishPrimerTwolevelDynamic2020

# Dynamic Structural Equation Modeling (DSEM)

Introduced by @asparouhovDynamicStructuralEquation2018.

## DSEM

:::{.incremental}
- Parameters may vary between timepoints and between individuals.
- Within-individuals model
\begin{align}
    \boldsymbol{y}_{1,it} = \boldsymbol{\nu}_{1} + \sum_{l=0}^{L} \boldsymbol{\Lambda}_{1,l} \boldsymbol{\eta}_{1,i,t-l} + \sum_{l=0}^{L} \boldsymbol{R}_{l} \boldsymbol{y}_{1,i,t-l} + \boldsymbol{K}_{1} \boldsymbol{X}_{1,it} + \boldsymbol{\epsilon}_{1,it} \\
    \boldsymbol{\eta}_{1,it} = \boldsymbol{\alpha}_{1} + \sum_{l=0}^{L} \boldsymbol{B}_{1,l} \boldsymbol{\eta}_{1,i,t-l} + \sum_{l=0}^{L} \boldsymbol{Q}_{l} \boldsymbol{y}_{1,i,t-l} + \boldsymbol{\Gamma}_{1} \boldsymbol{X}_{1,it} + \boldsymbol{\xi}_{1,it}.
\label{eq:WithinLevelModel}
\end{align}
:::

## Two Issues

:::{.incremental}
- Issue 1: Cyclic behavior and nonlinear trends.
- Issue 2: Computation scales poorly when using latent variables.
- Issue 3: Proprietary software, impossible to extend.
:::

# Issue 1: Cycles and nonlinear trends

@sorensenModelingCyclesTrends2025

---

![](images/descriptives.png){fig-align="center"}

## DSEM with Splines

- Detrending each individual timeseries prior to analysis would lead to bias!

## DSEM with Splines

\begin{equation}
    \label{eq:SplineVAR1}
    \boldsymbol{y}_{it} = \boldsymbol{\alpha}_{i} + \boldsymbol{f}_{i}\left(\boldsymbol{x}_{it}\right) + \boldsymbol{\Phi}_{i} \left\{\boldsymbol{y}_{i,t-1} - \boldsymbol{\alpha}_{i} -  \boldsymbol{f}_{i}\left(\boldsymbol{x}_{i,t-1}\right)\right\} + \boldsymbol{\delta}_{i},
\end{equation}

. . .

\begin{align}
    \label{eq:VARAlphaLevel2}
    \boldsymbol{\alpha}_{i} &= \boldsymbol{\gamma}_{\alpha} + \boldsymbol{u}_{\alpha i} \\        
    \label{eq:VARPhiLevel2}
    \text{vec}\left(\boldsymbol{\Phi}_{i}\right) &= \boldsymbol{\gamma}_{\phi} + \boldsymbol{u}_{\phi i} \\
    \label{eq:VARPsiLevel2}
    \log \boldsymbol{\psi}_{i}^{2} &= \boldsymbol{\gamma}_{\psi} + \boldsymbol{u}_{\psi i} \\
    \label{eq:VARSmoothLevel2}
    \boldsymbol{f}_{i}\left(\boldsymbol{x}_{it}\right) &= \boldsymbol{s}\left(\boldsymbol{x}_{it}\right) + \boldsymbol{s}_{p}\left(\boldsymbol{x}_{it}\right) + \boldsymbol{s}_{i}\left(\boldsymbol{x}_{it}\right).
\end{align}

## Hierarchical Smooth Terms

![](images/hierarchical_smooths.png){fig-align="center"}

## Open Source Implementation

- Stan [@carpenterStanProbabilisticProgramming2017] code in [OSF repository](https://osf.io/qpkmg/).
- No U-Turn Sampler (NUTS) [@hoffmanNoUTurnSamplerAdaptively2014] with:
  - Weakly informative priors.
  - Regression splines, intermediate rank apprach to smoothing [@woodFastStableRestricted2011].

# Example Application

Diary data of alcohol consumption, desire to drink and perceived stress [@carneyPositiveNegativeDaily2000]. 

## Population-Level Cycles and Trends

![](images/ar_smooths.png){fig-align="center"}

## Individual-Level Dynamics

![](images/individual_histograms.png){fig-align="center"}

## Individual Cyclic Terms

![](images/var_smooths.png){fig-align="center"}

# Issue 2: Computation with Latent Variables

Manuscript in preparation, Sørensen (2025).

# DSEM in Detail

## Response Decomposition

\begin{equation}
\label{eq:ResponseDecomposition}
    \boldsymbol{y}_{it} = \boldsymbol{y}_{1,it} + \boldsymbol{y}_{2,i} + \boldsymbol{y}_{3,t}.
\end{equation}

## Between-Timepoints Model

\begin{align}
    \boldsymbol{y}_{3,t} &= \boldsymbol{\nu}_{3} + \boldsymbol{\Lambda}_{3} \boldsymbol{\eta}_{3,t} + \boldsymbol{K}_{3} \boldsymbol{X}_{3,t} + \boldsymbol{\epsilon}_{3,t} \\    
    \boldsymbol{\eta}_{3,t} &= \boldsymbol{\alpha}_{3} + \boldsymbol{B}_{3}\boldsymbol{\eta}_{3,t} + \boldsymbol{\Gamma}_{3}\boldsymbol{X}_{3,t} + \boldsymbol{\zeta}_{3,t}.
\label{eq:BetweenTimepointModel}
\end{align}

## Between-Individuals Model

\begin{align}
    \boldsymbol{y}_{2,i} &= \boldsymbol{\nu}_{2} + \boldsymbol{\Lambda}_{2} \boldsymbol{\eta}_{2,i} + \boldsymbol{K}_{2}\boldsymbol{X}_{2,i} + \boldsymbol{\epsilon}_{2,i} \\    
    \boldsymbol{\eta}_{2,i} &= \boldsymbol{\alpha}_{2} + \boldsymbol{B}_{2} \boldsymbol{\eta}_{2,i} + \boldsymbol{\Gamma}_{2} \boldsymbol{X}_{2,i} + \boldsymbol{\xi}_{2,i},
\label{eq:BetweenIndividualModel}
\end{align}

## Within-Level Model

\begin{align}
    \boldsymbol{y}_{1,it} &= \boldsymbol{\nu}_{1,it} + \sum_{l=0}^{L} \boldsymbol{\Lambda}_{1,lit} \boldsymbol{\eta}_{1,i,t-l} + \sum_{l=0}^{L} \boldsymbol{R}_{lit} \boldsymbol{y}_{1,i,t-l} + \boldsymbol{K}_{1,it} \boldsymbol{X}_{1,it} + \boldsymbol{\epsilon}_{1,it} \\    
    \boldsymbol{\eta}_{1,it} &= \boldsymbol{\alpha}_{1,it} + \sum_{l=0}^{L} \boldsymbol{B}_{1,lit} \boldsymbol{\eta}_{1,i,t-l} + \sum_{l=0}^{L} \boldsymbol{Q}_{lit} \boldsymbol{y}_{1,i,t-l} + \boldsymbol{\Gamma}_{1,it} \boldsymbol{X}_{1,it} + \boldsymbol{\xi}_{1,it}.
\end{align}

## Sampling of Latent States

- Gibbs sampler of @asparouhovDynamicStructuralEquation2018 samples latent states $\boldsymbol{\eta}_{1,it}$ for $i=1,\dots,N$ and $t=1,\dots,T$ conditionally on all other parameters.

## Theorem in Forthcoming Paper

:::{.incremental}
- Within-level DSEM is equivalent to
\begin{align}
\label{eq:DSEMStateSpaceTheorem}
    \boldsymbol{y}_{1,it} &= \boldsymbol{Z}_{it} \tilde{\boldsymbol{\eta}}_{1,it} + \boldsymbol{d}_{it} + \boldsymbol{v}_{it}, \quad \boldsymbol{v}_{it} \sim N\left(\boldsymbol{0}, \boldsymbol{H}_{it}\right)  \\
    \tilde{\boldsymbol{\eta}}_{1,it} &= \boldsymbol{T}_{it} \tilde{\boldsymbol{\eta}}_{1,i,t-1} + \boldsymbol{c}_{it} + \boldsymbol{w}_{it}, \quad \boldsymbol{w}_{it} \sim N\left(\boldsymbol{0}, \boldsymbol{W}_{it}\right),
\end{align}
- Let's us compute marginal likelihood conditional on all other parameters analytically, using the Kalman filter.
:::

# Thank you!

Any questions?

## References